"use strict";
// Copyright 2013 Google LLC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
Object.defineProperty(exports, "__esModule", ***REMOVED*** value: true });
exports.Compute = void 0;
const arrify = require("arrify");
const gaxios_1 = require("gaxios");
const gcpMetadata = require("gcp-metadata");
const oauth2client_1 = require("./oauth2client");
class Compute extends oauth2client_1.OAuth2Client ***REMOVED***
    /**
     * Google Compute Engine service account credentials.
     *
     * Retrieve access token from the metadata server.
     * See: https://developers.google.com/compute/docs/authentication
     */
    constructor(options = ***REMOVED***}) ***REMOVED***
        super(options);
        // Start with an expired refresh token, which will automatically be
        // refreshed before the first API call is made.
        this.credentials = ***REMOVED*** expiry_date: 1, refresh_token: 'compute-placeholder' };
        this.serviceAccountEmail = options.serviceAccountEmail || 'default';
        this.scopes = arrify(options.scopes);
  ***REMOVED***
    /**
     * Refreshes the access token.
     * @param refreshToken Unused parameter
     */
    async refreshTokenNoCache(
    // eslint-disable-next-line @typescript-eslint/no-unused-vars
    refreshToken) ***REMOVED***
        const tokenPath = `service-accounts/$***REMOVED***this.serviceAccountEmail}/token`;
        let data;
        try ***REMOVED***
            const instanceOptions = ***REMOVED***
                property: tokenPath,
          ***REMOVED***;
            if (this.scopes.length > 0) ***REMOVED***
                instanceOptions.params = ***REMOVED***
                    scopes: this.scopes.join(','),
              ***REMOVED***;
          ***REMOVED***
            data = await gcpMetadata.instance(instanceOptions);
      ***REMOVED***
        catch (e) ***REMOVED***
            if (e instanceof gaxios_1.GaxiosError) ***REMOVED***
                e.message = `Could not refresh access token: $***REMOVED***e.message}`;
                this.wrapError(e);
          ***REMOVED***
            throw e;
      ***REMOVED***
        const tokens = data;
        if (data && data.expires_in) ***REMOVED***
            tokens.expiry_date = new Date().getTime() + data.expires_in * 1000;
            delete tokens.expires_in;
      ***REMOVED***
        this.emit('tokens', tokens);
        return ***REMOVED*** tokens, res: null };
  ***REMOVED***
    /**
     * Fetches an ID token.
     * @param targetAudience the audience for the fetched ID token.
     */
    async fetchIdToken(targetAudience) ***REMOVED***
        const idTokenPath = `service-accounts/$***REMOVED***this.serviceAccountEmail}/identity` +
            `?format=full&audience=$***REMOVED***targetAudience}`;
        let idToken;
        try ***REMOVED***
            const instanceOptions = ***REMOVED***
                property: idTokenPath,
          ***REMOVED***;
            idToken = await gcpMetadata.instance(instanceOptions);
      ***REMOVED***
        catch (e) ***REMOVED***
            if (e instanceof Error) ***REMOVED***
                e.message = `Could not fetch ID token: $***REMOVED***e.message}`;
          ***REMOVED***
            throw e;
      ***REMOVED***
        return idToken;
  ***REMOVED***
    wrapError(e) ***REMOVED***
        const res = e.response;
        if (res && res.status) ***REMOVED***
            e.code = res.status.toString();
            if (res.status === 403) ***REMOVED***
                e.message =
                    'A Forbidden error was returned while attempting to retrieve an access ' +
                        'token for the Compute Engine built-in service account. This may be because the Compute ' +
                        'Engine instance does not have the correct permission scopes specified: ' +
                        e.message;
          ***REMOVED***
            else if (res.status === 404) ***REMOVED***
                e.message =
                    'A Not Found error was returned while attempting to retrieve an access' +
                        'token for the Compute Engine built-in service account. This may be because the Compute ' +
                        'Engine instance does not have any permission scopes specified: ' +
                        e.message;
          ***REMOVED***
      ***REMOVED***
  ***REMOVED***
}
exports.Compute = Compute;
//# sourceMappingURL=computeclient.js.map