import ***REMOVED*** diffieHellman, generateKeyPair as generateKeyPairCb, KeyObject } from 'crypto';
import ***REMOVED*** promisify } from 'util';
import getNamedCurve from './get_named_curve.js';
import ***REMOVED*** encoder, concat, uint32be, lengthAndInput, concatKdf } from '../lib/buffer_utils.js';
import ***REMOVED*** JOSENotSupported } from '../util/errors.js';
import ***REMOVED*** isCryptoKey } from './webcrypto.js';
import ***REMOVED*** checkEncCryptoKey } from '../lib/crypto_key.js';
import isKeyObject from './is_key_object.js';
import invalidKeyInput from '../lib/invalid_key_input.js';
import ***REMOVED*** types } from './is_key_like.js';
const generateKeyPair = promisify(generateKeyPairCb);
export async function deriveKey(publicKee, privateKee, algorithm, keyLength, apu = new Uint8Array(0), apv = new Uint8Array(0)) ***REMOVED***
    let publicKey;
    if (isCryptoKey(publicKee)) ***REMOVED***
        checkEncCryptoKey(publicKee, 'ECDH');
        publicKey = KeyObject.from(publicKee);
  ***REMOVED***
    else if (isKeyObject(publicKee)) ***REMOVED***
        publicKey = publicKee;
  ***REMOVED***
    else ***REMOVED***
        throw new TypeError(invalidKeyInput(publicKee, ...types));
  ***REMOVED***
    let privateKey;
    if (isCryptoKey(privateKee)) ***REMOVED***
        checkEncCryptoKey(privateKee, 'ECDH', 'deriveBits');
        privateKey = KeyObject.from(privateKee);
  ***REMOVED***
    else if (isKeyObject(privateKee)) ***REMOVED***
        privateKey = privateKee;
  ***REMOVED***
    else ***REMOVED***
        throw new TypeError(invalidKeyInput(privateKee, ...types));
  ***REMOVED***
    const value = concat(lengthAndInput(encoder.encode(algorithm)), lengthAndInput(apu), lengthAndInput(apv), uint32be(keyLength));
    const sharedSecret = diffieHellman(***REMOVED*** privateKey, publicKey });
    return concatKdf(sharedSecret, keyLength, value);
}
export async function generateEpk(kee) ***REMOVED***
    let key;
    if (isCryptoKey(kee)) ***REMOVED***
        key = KeyObject.from(kee);
  ***REMOVED***
    else if (isKeyObject(kee)) ***REMOVED***
        key = kee;
  ***REMOVED***
    else ***REMOVED***
        throw new TypeError(invalidKeyInput(kee, ...types));
  ***REMOVED***
    switch (key.asymmetricKeyType) ***REMOVED***
        case 'x25519':
            return generateKeyPair('x25519');
        case 'x448': ***REMOVED***
            return generateKeyPair('x448');
      ***REMOVED***
        case 'ec': ***REMOVED***
            const namedCurve = getNamedCurve(key);
            return generateKeyPair('ec', ***REMOVED*** namedCurve });
      ***REMOVED***
        default:
            throw new JOSENotSupported('Invalid or unsupported EPK');
  ***REMOVED***
}
export const ecdhAllowed = (key) => ['P-256', 'P-384', 'P-521', 'X25519', 'X448'].includes(getNamedCurve(key));
