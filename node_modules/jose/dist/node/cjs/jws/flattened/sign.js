"use strict";
Object.defineProperty(exports, "__esModule", ***REMOVED*** value: true });
exports.FlattenedSign = void 0;
const base64url_js_1 = require("../../runtime/base64url.js");
const sign_js_1 = require("../../runtime/sign.js");
const is_disjoint_js_1 = require("../../lib/is_disjoint.js");
const errors_js_1 = require("../../util/errors.js");
const buffer_utils_js_1 = require("../../lib/buffer_utils.js");
const check_key_type_js_1 = require("../../lib/check_key_type.js");
const validate_crit_js_1 = require("../../lib/validate_crit.js");
class FlattenedSign ***REMOVED***
    constructor(payload) ***REMOVED***
        if (!(payload instanceof Uint8Array)) ***REMOVED***
            throw new TypeError('payload must be an instance of Uint8Array');
      ***REMOVED***
        this._payload = payload;
  ***REMOVED***
    setProtectedHeader(protectedHeader) ***REMOVED***
        if (this._protectedHeader) ***REMOVED***
            throw new TypeError('setProtectedHeader can only be called once');
      ***REMOVED***
        this._protectedHeader = protectedHeader;
        return this;
  ***REMOVED***
    setUnprotectedHeader(unprotectedHeader) ***REMOVED***
        if (this._unprotectedHeader) ***REMOVED***
            throw new TypeError('setUnprotectedHeader can only be called once');
      ***REMOVED***
        this._unprotectedHeader = unprotectedHeader;
        return this;
  ***REMOVED***
    async sign(key, options) ***REMOVED***
        if (!this._protectedHeader && !this._unprotectedHeader) ***REMOVED***
            throw new errors_js_1.JWSInvalid('either setProtectedHeader or setUnprotectedHeader must be called before #sign()');
      ***REMOVED***
        if (!(0, is_disjoint_js_1.default)(this._protectedHeader, this._unprotectedHeader)) ***REMOVED***
            throw new errors_js_1.JWSInvalid('JWS Protected and JWS Unprotected Header Parameter names must be disjoint');
      ***REMOVED***
        const joseHeader = ***REMOVED***
            ...this._protectedHeader,
            ...this._unprotectedHeader,
      ***REMOVED***;
        const extensions = (0, validate_crit_js_1.default)(errors_js_1.JWSInvalid, new Map([['b64', true]]), options === null || options === void 0 ? void 0 : options.crit, this._protectedHeader, joseHeader);
        let b64 = true;
        if (extensions.has('b64')) ***REMOVED***
            b64 = this._protectedHeader.b64;
            if (typeof b64 !== 'boolean') ***REMOVED***
                throw new errors_js_1.JWSInvalid('The "b64" (base64url-encode payload) Header Parameter must be a boolean');
          ***REMOVED***
      ***REMOVED***
        const ***REMOVED*** alg } = joseHeader;
        if (typeof alg !== 'string' || !alg) ***REMOVED***
            throw new errors_js_1.JWSInvalid('JWS "alg" (Algorithm) Header Parameter missing or invalid');
      ***REMOVED***
        (0, check_key_type_js_1.default)(alg, key, 'sign');
        let payload = this._payload;
        if (b64) ***REMOVED***
            payload = buffer_utils_js_1.encoder.encode((0, base64url_js_1.encode)(payload));
      ***REMOVED***
        let protectedHeader;
        if (this._protectedHeader) ***REMOVED***
            protectedHeader = buffer_utils_js_1.encoder.encode((0, base64url_js_1.encode)(JSON.stringify(this._protectedHeader)));
      ***REMOVED***
        else ***REMOVED***
            protectedHeader = buffer_utils_js_1.encoder.encode('');
      ***REMOVED***
        const data = (0, buffer_utils_js_1.concat)(protectedHeader, buffer_utils_js_1.encoder.encode('.'), payload);
        const signature = await (0, sign_js_1.default)(alg, key, data);
        const jws = ***REMOVED***
            signature: (0, base64url_js_1.encode)(signature),
            payload: '',
      ***REMOVED***;
        if (b64) ***REMOVED***
            jws.payload = buffer_utils_js_1.decoder.decode(payload);
      ***REMOVED***
        if (this._unprotectedHeader) ***REMOVED***
            jws.header = this._unprotectedHeader;
      ***REMOVED***
        if (this._protectedHeader) ***REMOVED***
            jws.protected = buffer_utils_js_1.decoder.decode(protectedHeader);
      ***REMOVED***
        return jws;
  ***REMOVED***
}
exports.FlattenedSign = FlattenedSign;
