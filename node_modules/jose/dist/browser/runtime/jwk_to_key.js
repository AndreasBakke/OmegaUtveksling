import ***REMOVED*** isCloudflareWorkers } from './env.js';
import crypto from './webcrypto.js';
import ***REMOVED*** JOSENotSupported } from '../util/errors.js';
import ***REMOVED*** decode as base64url } from './base64url.js';
function subtleMapping(jwk) ***REMOVED***
    let algorithm;
    let keyUsages;
    switch (jwk.kty) ***REMOVED***
        case 'oct': ***REMOVED***
            switch (jwk.alg) ***REMOVED***
                case 'HS256':
                case 'HS384':
                case 'HS512':
                    algorithm = ***REMOVED*** name: 'HMAC', hash: `SHA-$***REMOVED***jwk.alg.slice(-3)}` };
                    keyUsages = ['sign', 'verify'];
                    break;
                case 'A128CBC-HS256':
                case 'A192CBC-HS384':
                case 'A256CBC-HS512':
                    throw new JOSENotSupported(`$***REMOVED***jwk.alg} keys cannot be imported as CryptoKey instances`);
                case 'A128GCM':
                case 'A192GCM':
                case 'A256GCM':
                case 'A128GCMKW':
                case 'A192GCMKW':
                case 'A256GCMKW':
                    algorithm = ***REMOVED*** name: 'AES-GCM' };
                    keyUsages = ['encrypt', 'decrypt'];
                    break;
                case 'A128KW':
                case 'A192KW':
                case 'A256KW':
                    algorithm = ***REMOVED*** name: 'AES-KW' };
                    keyUsages = ['wrapKey', 'unwrapKey'];
                    break;
                case 'PBES2-HS256+A128KW':
                case 'PBES2-HS384+A192KW':
                case 'PBES2-HS512+A256KW':
                    algorithm = ***REMOVED*** name: 'PBKDF2' };
                    keyUsages = ['deriveBits'];
                    break;
                default:
                    throw new JOSENotSupported('Invalid or unsupported JWK "alg" (Algorithm) Parameter value');
          ***REMOVED***
            break;
      ***REMOVED***
        case 'RSA': ***REMOVED***
            switch (jwk.alg) ***REMOVED***
                case 'PS256':
                case 'PS384':
                case 'PS512':
                    algorithm = ***REMOVED*** name: 'RSA-PSS', hash: `SHA-$***REMOVED***jwk.alg.slice(-3)}` };
                    keyUsages = jwk.d ? ['sign'] : ['verify'];
                    break;
                case 'RS256':
                case 'RS384':
                case 'RS512':
                    algorithm = ***REMOVED*** name: 'RSASSA-PKCS1-v1_5', hash: `SHA-$***REMOVED***jwk.alg.slice(-3)}` };
                    keyUsages = jwk.d ? ['sign'] : ['verify'];
                    break;
                case 'RSA-OAEP':
                case 'RSA-OAEP-256':
                case 'RSA-OAEP-384':
                case 'RSA-OAEP-512':
                    algorithm = ***REMOVED***
                        name: 'RSA-OAEP',
                        hash: `SHA-$***REMOVED***parseInt(jwk.alg.slice(-3), 10) || 1}`,
                  ***REMOVED***;
                    keyUsages = jwk.d ? ['decrypt', 'unwrapKey'] : ['encrypt', 'wrapKey'];
                    break;
                default:
                    throw new JOSENotSupported('Invalid or unsupported JWK "alg" (Algorithm) Parameter value');
          ***REMOVED***
            break;
      ***REMOVED***
        case 'EC': ***REMOVED***
            switch (jwk.alg) ***REMOVED***
                case 'ES256':
                    algorithm = ***REMOVED*** name: 'ECDSA', namedCurve: 'P-256' };
                    keyUsages = jwk.d ? ['sign'] : ['verify'];
                    break;
                case 'ES384':
                    algorithm = ***REMOVED*** name: 'ECDSA', namedCurve: 'P-384' };
                    keyUsages = jwk.d ? ['sign'] : ['verify'];
                    break;
                case 'ES512':
                    algorithm = ***REMOVED*** name: 'ECDSA', namedCurve: 'P-521' };
                    keyUsages = jwk.d ? ['sign'] : ['verify'];
                    break;
                case 'ECDH-ES':
                case 'ECDH-ES+A128KW':
                case 'ECDH-ES+A192KW':
                case 'ECDH-ES+A256KW':
                    algorithm = ***REMOVED*** name: 'ECDH', namedCurve: jwk.crv };
                    keyUsages = jwk.d ? ['deriveBits'] : [];
                    break;
                default:
                    throw new JOSENotSupported('Invalid or unsupported JWK "alg" (Algorithm) Parameter value');
          ***REMOVED***
            break;
      ***REMOVED***
        case isCloudflareWorkers() && 'OKP':
            if (jwk.alg !== 'EdDSA') ***REMOVED***
                throw new JOSENotSupported('Invalid or unsupported JWK "alg" (Algorithm) Parameter value');
          ***REMOVED***
            switch (jwk.crv) ***REMOVED***
                case 'Ed25519':
                    algorithm = ***REMOVED*** name: 'NODE-ED25519', namedCurve: 'NODE-ED25519' };
                    keyUsages = jwk.d ? ['sign'] : ['verify'];
                    break;
                default:
                    throw new JOSENotSupported('Invalid or unsupported JWK "alg" (Algorithm) Parameter value');
          ***REMOVED***
            break;
        case 'OKP': ***REMOVED***
            switch (jwk.alg) ***REMOVED***
                case 'EdDSA':
                    algorithm = ***REMOVED*** name: jwk.crv };
                    keyUsages = jwk.d ? ['sign'] : ['verify'];
                    break;
                case 'ECDH-ES':
                case 'ECDH-ES+A128KW':
                case 'ECDH-ES+A192KW':
                case 'ECDH-ES+A256KW':
                    algorithm = ***REMOVED*** name: jwk.crv };
                    keyUsages = jwk.d ? ['deriveBits'] : [];
                    break;
                default:
                    throw new JOSENotSupported('Invalid or unsupported JWK "alg" (Algorithm) Parameter value');
          ***REMOVED***
            break;
      ***REMOVED***
        default:
            throw new JOSENotSupported('Invalid or unsupported JWK "kty" (Key Type) Parameter value');
  ***REMOVED***
    return ***REMOVED*** algorithm, keyUsages };
}
const parse = async (jwk) => ***REMOVED***
    var _a, _b;
    const ***REMOVED*** algorithm, keyUsages } = subtleMapping(jwk);
    const rest = [
        algorithm,
        (_a = jwk.ext) !== null && _a !== void 0 ? _a : false,
        (_b = jwk.key_ops) !== null && _b !== void 0 ? _b : keyUsages,
    ];
    if (algorithm.name === 'PBKDF2') ***REMOVED***
        return crypto.subtle.importKey('raw', base64url(jwk.k), ...rest);
  ***REMOVED***
    const keyData = ***REMOVED*** ...jwk };
    delete keyData.alg;
    delete keyData.use;
    return crypto.subtle.importKey('jwk', keyData, ...rest);
};
export default parse;
