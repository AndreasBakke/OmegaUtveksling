import fetchJwks from '../runtime/fetch_jwks.js';
import ***REMOVED*** isCloudflareWorkers } from '../runtime/env.js';
import ***REMOVED*** JWKSInvalid, JWKSNoMatchingKey } from '../util/errors.js';
import ***REMOVED*** isJWKSLike, LocalJWKSet } from './local.js';
class RemoteJWKSet extends LocalJWKSet ***REMOVED***
    constructor(url, options) ***REMOVED***
        super(***REMOVED*** keys: [] });
        this._jwks = undefined;
        if (!(url instanceof URL)) ***REMOVED***
            throw new TypeError('url must be an instance of URL');
      ***REMOVED***
        this._url = new URL(url.href);
        this._options = ***REMOVED*** agent: options === null || options === void 0 ? void 0 : options.agent, headers: options === null || options === void 0 ? void 0 : options.headers };
        this._timeoutDuration =
            typeof (options === null || options === void 0 ? void 0 : options.timeoutDuration) === 'number' ? options === null || options === void 0 ? void 0 : options.timeoutDuration : 5000;
        this._cooldownDuration =
            typeof (options === null || options === void 0 ? void 0 : options.cooldownDuration) === 'number' ? options === null || options === void 0 ? void 0 : options.cooldownDuration : 30000;
        this._cacheMaxAge = typeof (options === null || options === void 0 ? void 0 : options.cacheMaxAge) === 'number' ? options === null || options === void 0 ? void 0 : options.cacheMaxAge : 600000;
  ***REMOVED***
    coolingDown() ***REMOVED***
        return typeof this._jwksTimestamp === 'number'
            ? Date.now() < this._jwksTimestamp + this._cooldownDuration
            : false;
  ***REMOVED***
    fresh() ***REMOVED***
        return typeof this._jwksTimestamp === 'number'
            ? Date.now() < this._jwksTimestamp + this._cacheMaxAge
            : false;
  ***REMOVED***
    async getKey(protectedHeader, token) ***REMOVED***
        if (!this._jwks || !this.fresh()) ***REMOVED***
            await this.reload();
      ***REMOVED***
        try ***REMOVED***
            return await super.getKey(protectedHeader, token);
      ***REMOVED***
        catch (err) ***REMOVED***
            if (err instanceof JWKSNoMatchingKey) ***REMOVED***
                if (this.coolingDown() === false) ***REMOVED***
                    await this.reload();
                    return super.getKey(protectedHeader, token);
              ***REMOVED***
          ***REMOVED***
            throw err;
      ***REMOVED***
  ***REMOVED***
    async reload() ***REMOVED***
        if (this._pendingFetch && isCloudflareWorkers()) ***REMOVED***
            return new Promise((resolve) => ***REMOVED***
                const isDone = () => ***REMOVED***
                    if (this._pendingFetch === undefined) ***REMOVED***
                        resolve();
                  ***REMOVED***
                    else ***REMOVED***
                        setTimeout(isDone, 5);
                  ***REMOVED***
              ***REMOVED***;
                isDone();
          ***REMOVED***);
      ***REMOVED***
        if (!this._pendingFetch) ***REMOVED***
            this._pendingFetch = fetchJwks(this._url, this._timeoutDuration, this._options)
                .then((json) => ***REMOVED***
                if (!isJWKSLike(json)) ***REMOVED***
                    throw new JWKSInvalid('JSON Web Key Set malformed');
              ***REMOVED***
                this._jwks = ***REMOVED*** keys: json.keys };
                this._jwksTimestamp = Date.now();
                this._pendingFetch = undefined;
          ***REMOVED***)
                .catch((err) => ***REMOVED***
                this._pendingFetch = undefined;
                throw err;
          ***REMOVED***);
      ***REMOVED***
        await this._pendingFetch;
  ***REMOVED***
}
export function createRemoteJWKSet(url, options) ***REMOVED***
    return RemoteJWKSet.prototype.getKey.bind(new RemoteJWKSet(url, options));
}
