import ***REMOVED*** JWTClaimValidationFailed, JWTExpired, JWTInvalid } from '../util/errors.js';
import ***REMOVED*** decoder } from './buffer_utils.js';
import epoch from './epoch.js';
import secs from './secs.js';
import isObject from './is_object.js';
const normalizeTyp = (value) => value.toLowerCase().replace(/^application\//, '');
const checkAudiencePresence = (audPayload, audOption) => ***REMOVED***
    if (typeof audPayload === 'string') ***REMOVED***
        return audOption.includes(audPayload);
  ***REMOVED***
    if (Array.isArray(audPayload)) ***REMOVED***
        return audOption.some(Set.prototype.has.bind(new Set(audPayload)));
  ***REMOVED***
    return false;
};
export default (protectedHeader, encodedPayload, options = ***REMOVED***}) => ***REMOVED***
    const ***REMOVED*** typ } = options;
    if (typ &&
        (typeof protectedHeader.typ !== 'string' ||
            normalizeTyp(protectedHeader.typ) !== normalizeTyp(typ))) ***REMOVED***
        throw new JWTClaimValidationFailed('unexpected "typ" JWT header value', 'typ', 'check_failed');
  ***REMOVED***
    let payload;
    try ***REMOVED***
        payload = JSON.parse(decoder.decode(encodedPayload));
  ***REMOVED***
    catch (_a) ***REMOVED***
  ***REMOVED***
    if (!isObject(payload)) ***REMOVED***
        throw new JWTInvalid('JWT Claims Set must be a top-level JSON object');
  ***REMOVED***
    const ***REMOVED*** issuer } = options;
    if (issuer && !(Array.isArray(issuer) ? issuer : [issuer]).includes(payload.iss)) ***REMOVED***
        throw new JWTClaimValidationFailed('unexpected "iss" claim value', 'iss', 'check_failed');
  ***REMOVED***
    const ***REMOVED*** subject } = options;
    if (subject && payload.sub !== subject) ***REMOVED***
        throw new JWTClaimValidationFailed('unexpected "sub" claim value', 'sub', 'check_failed');
  ***REMOVED***
    const ***REMOVED*** audience } = options;
    if (audience &&
        !checkAudiencePresence(payload.aud, typeof audience === 'string' ? [audience] : audience)) ***REMOVED***
        throw new JWTClaimValidationFailed('unexpected "aud" claim value', 'aud', 'check_failed');
  ***REMOVED***
    let tolerance;
    switch (typeof options.clockTolerance) ***REMOVED***
        case 'string':
            tolerance = secs(options.clockTolerance);
            break;
        case 'number':
            tolerance = options.clockTolerance;
            break;
        case 'undefined':
            tolerance = 0;
            break;
        default:
            throw new TypeError('Invalid clockTolerance option type');
  ***REMOVED***
    const ***REMOVED*** currentDate } = options;
    const now = epoch(currentDate || new Date());
    if ((payload.iat !== undefined || options.maxTokenAge) && typeof payload.iat !== 'number') ***REMOVED***
        throw new JWTClaimValidationFailed('"iat" claim must be a number', 'iat', 'invalid');
  ***REMOVED***
    if (payload.nbf !== undefined) ***REMOVED***
        if (typeof payload.nbf !== 'number') ***REMOVED***
            throw new JWTClaimValidationFailed('"nbf" claim must be a number', 'nbf', 'invalid');
      ***REMOVED***
        if (payload.nbf > now + tolerance) ***REMOVED***
            throw new JWTClaimValidationFailed('"nbf" claim timestamp check failed', 'nbf', 'check_failed');
      ***REMOVED***
  ***REMOVED***
    if (payload.exp !== undefined) ***REMOVED***
        if (typeof payload.exp !== 'number') ***REMOVED***
            throw new JWTClaimValidationFailed('"exp" claim must be a number', 'exp', 'invalid');
      ***REMOVED***
        if (payload.exp <= now - tolerance) ***REMOVED***
            throw new JWTExpired('"exp" claim timestamp check failed', 'exp', 'check_failed');
      ***REMOVED***
  ***REMOVED***
    if (options.maxTokenAge) ***REMOVED***
        const age = now - payload.iat;
        const max = typeof options.maxTokenAge === 'number' ? options.maxTokenAge : secs(options.maxTokenAge);
        if (age - tolerance > max) ***REMOVED***
            throw new JWTExpired('"iat" claim timestamp check failed (too far in the past)', 'iat', 'check_failed');
      ***REMOVED***
        if (age < 0 - tolerance) ***REMOVED***
            throw new JWTClaimValidationFailed('"iat" claim timestamp check failed (it should be in the past)', 'iat', 'check_failed');
      ***REMOVED***
  ***REMOVED***
    return payload;
};
