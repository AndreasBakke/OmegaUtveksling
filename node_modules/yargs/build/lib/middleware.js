import ***REMOVED*** argsert } from './argsert.js';
import ***REMOVED*** isPromise } from './utils/is-promise.js';
export function globalMiddlewareFactory(globalMiddleware, context) ***REMOVED***
    return function (callback, applyBeforeValidation = false) ***REMOVED***
        argsert('<array|function> [boolean]', [callback, applyBeforeValidation], arguments.length);
        if (Array.isArray(callback)) ***REMOVED***
            for (let i = 0; i < callback.length; i++) ***REMOVED***
                if (typeof callback[i] !== 'function') ***REMOVED***
                    throw Error('middleware must be a function');
              ***REMOVED***
                callback[i].applyBeforeValidation = applyBeforeValidation;
          ***REMOVED***
            Array.prototype.push.apply(globalMiddleware, callback);
      ***REMOVED***
        else if (typeof callback === 'function') ***REMOVED***
            callback.applyBeforeValidation = applyBeforeValidation;
            globalMiddleware.push(callback);
      ***REMOVED***
        return context;
  ***REMOVED***;
}
export function commandMiddlewareFactory(commandMiddleware) ***REMOVED***
    if (!commandMiddleware)
        return [];
    return commandMiddleware.map(middleware => ***REMOVED***
        middleware.applyBeforeValidation = false;
        return middleware;
  ***REMOVED***);
}
export function applyMiddleware(argv, yargs, middlewares, beforeValidation) ***REMOVED***
    const beforeValidationError = new Error('middleware cannot return a promise when applyBeforeValidation is true');
    return middlewares.reduce((acc, middleware) => ***REMOVED***
        if (middleware.applyBeforeValidation !== beforeValidation) ***REMOVED***
            return acc;
      ***REMOVED***
        if (isPromise(acc)) ***REMOVED***
            return acc
                .then(initialObj => Promise.all([
                initialObj,
                middleware(initialObj, yargs),
            ]))
                .then(([initialObj, middlewareObj]) => Object.assign(initialObj, middlewareObj));
      ***REMOVED***
        else ***REMOVED***
            const result = middleware(acc, yargs);
            if (beforeValidation && isPromise(result))
                throw beforeValidationError;
            return isPromise(result)
                ? result.then(middlewareObj => Object.assign(acc, middlewareObj))
                : Object.assign(acc, result);
      ***REMOVED***
  ***REMOVED***, argv);
}
