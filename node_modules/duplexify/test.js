var tape = require('tape')
var through = require('through2')
var concat = require('concat-stream')
var stream = require('readable-stream')
var net = require('net')
var duplexify = require('./')

var HELLO_WORLD = (Buffer.from && Buffer.from !== Uint8Array.from)
 ? Buffer.from('hello world')
 : new Buffer('hello world')

tape('passthrough', function(t) ***REMOVED***
  t.plan(2)

  var pt = through()
  var dup = duplexify(pt, pt)

  dup.end('hello world')
  dup.on('finish', function() ***REMOVED***
    t.ok(true, 'should finish')
***REMOVED***)
  dup.pipe(concat(function(data) ***REMOVED***
    t.same(data.toString(), 'hello world', 'same in as out')
***REMOVED***))
})

tape('passthrough + double end', function(t) ***REMOVED***
  t.plan(2)

  var pt = through()
  var dup = duplexify(pt, pt)

  dup.end('hello world')
  dup.end()

  dup.on('finish', function() ***REMOVED***
    t.ok(true, 'should finish')
***REMOVED***)
  dup.pipe(concat(function(data) ***REMOVED***
    t.same(data.toString(), 'hello world', 'same in as out')
***REMOVED***))
})

tape('async passthrough + end', function(t) ***REMOVED***
  t.plan(2)

  var pt = through.obj(***REMOVED***highWaterMark:1}, function(data, enc, cb) ***REMOVED***
    setTimeout(function() ***REMOVED***
      cb(null, data)
  ***REMOVED***, 100)
***REMOVED***)

  var dup = duplexify(pt, pt)

  dup.write('hello ')
  dup.write('world')
  dup.end()

  dup.on('finish', function() ***REMOVED***
    t.ok(true, 'should finish')
***REMOVED***)
  dup.pipe(concat(function(data) ***REMOVED***
    t.same(data.toString(), 'hello world', 'same in as out')
***REMOVED***))
})

tape('duplex', function(t) ***REMOVED***
  var readExpected = ['read-a', 'read-b', 'read-c']
  var writeExpected = ['write-a', 'write-b', 'write-c']

  t.plan(readExpected.length+writeExpected.length+2)

  var readable = through.obj()
  var writable = through.obj(function(data, enc, cb) ***REMOVED***
    t.same(data, writeExpected.shift(), 'onwrite should match')
    cb()
***REMOVED***)

  var dup = duplexify.obj(writable, readable)

  readExpected.slice().forEach(function(data) ***REMOVED***
    readable.write(data)
***REMOVED***)
  readable.end()

  writeExpected.slice().forEach(function(data) ***REMOVED***
    dup.write(data)
***REMOVED***)
  dup.end()

  dup.on('data', function(data) ***REMOVED***
    t.same(data, readExpected.shift(), 'ondata should match')
***REMOVED***)
  dup.on('end', function() ***REMOVED***
    t.ok(true, 'should end')
***REMOVED***)
  dup.on('finish', function() ***REMOVED***
    t.ok(true, 'should finish')
***REMOVED***)
})

tape('async', function(t) ***REMOVED***
  var dup = duplexify()
  var pt = through()

  dup.pipe(concat(function(data) ***REMOVED***
    t.same(data.toString(), 'i was async', 'same in as out')
    t.end()
***REMOVED***))

  dup.write('i')
  dup.write(' was ')
  dup.end('async')

  setTimeout(function() ***REMOVED***
    dup.setWritable(pt)
    setTimeout(function() ***REMOVED***
      dup.setReadable(pt)
  ***REMOVED***, 50)
***REMOVED***, 50)
})

tape('destroy', function(t) ***REMOVED***
  t.plan(2)

  var write = through()
  var read = through()
  var dup = duplexify(write, read)

  write.destroy = function() ***REMOVED***
    t.ok(true, 'write destroyed')
***REMOVED***

  dup.on('close', function() ***REMOVED***
    t.ok(true, 'close emitted')
***REMOVED***)

  dup.destroy()
  dup.destroy() // should only work once
  dup.end()
})

tape('destroy both', function(t) ***REMOVED***
  t.plan(3)

  var write = through()
  var read = through()
  var dup = duplexify(write, read)

  write.destroy = function() ***REMOVED***
    t.ok(true, 'write destroyed')
***REMOVED***

  read.destroy = function() ***REMOVED***
    t.ok(true, 'read destroyed')
***REMOVED***

  dup.on('close', function() ***REMOVED***
    t.ok(true, 'close emitted')
***REMOVED***)

  dup.destroy()
  dup.destroy() // should only work once
})

tape('bubble read errors', function(t) ***REMOVED***
  t.plan(2)

  var write = through()
  var read = through()
  var dup = duplexify(write, read)

  dup.on('error', function(err) ***REMOVED***
    t.same(err.message, 'read-error', 'received read error')
***REMOVED***)
  dup.on('close', function() ***REMOVED***
    t.ok(true, 'close emitted')
***REMOVED***)

  read.emit('error', new Error('read-error'))
  write.emit('error', new Error('write-error')) // only emit first error
})

tape('bubble write errors', function(t) ***REMOVED***
  t.plan(2)

  var write = through()
  var read = through()
  var dup = duplexify(write, read)

  dup.on('error', function(err) ***REMOVED***
    t.same(err.message, 'write-error', 'received write error')
***REMOVED***)
  dup.on('close', function() ***REMOVED***
    t.ok(true, 'close emitted')
***REMOVED***)

  write.emit('error', new Error('write-error'))
  read.emit('error', new Error('read-error')) // only emit first error
})

tape('bubble errors from write()', function(t) ***REMOVED***
  t.plan(3)

  var errored = false
  var dup = duplexify(new stream.Writable(***REMOVED***
    write: function(chunk, enc, next) ***REMOVED***
      next(new Error('write-error'))
  ***REMOVED***
***REMOVED***))

  dup.on('error', function(err) ***REMOVED***
    errored = true
    t.same(err.message, 'write-error', 'received write error')
***REMOVED***)
  dup.on('close', function() ***REMOVED***
    t.pass('close emitted')
    t.ok(errored, 'error was emitted before close')
***REMOVED***)
  dup.end('123')
})

tape('destroy while waiting for drain', function(t) ***REMOVED***
  t.plan(3)

  var errored = false
  var dup = duplexify(new stream.Writable(***REMOVED***
    highWaterMark: 0,
    write: function() ***REMOVED***}
***REMOVED***))

  dup.on('error', function(err) ***REMOVED***
    errored = true
    t.same(err.message, 'destroy-error', 'received destroy error')
***REMOVED***)
  dup.on('close', function() ***REMOVED***
    t.pass('close emitted')
    t.ok(errored, 'error was emitted before close')
***REMOVED***)
  dup.write('123')
  dup.destroy(new Error('destroy-error'))
})

tape('reset writable / readable', function(t) ***REMOVED***
  t.plan(3)

  var toUpperCase = function(data, enc, cb) ***REMOVED***
    cb(null, data.toString().toUpperCase())
***REMOVED***

  var passthrough = through()
  var upper = through(toUpperCase)
  var dup = duplexify(passthrough, passthrough)

  dup.once('data', function(data) ***REMOVED***
    t.same(data.toString(), 'hello')
    dup.setWritable(upper)
    dup.setReadable(upper)
    dup.once('data', function(data) ***REMOVED***
      t.same(data.toString(), 'HELLO')
      dup.once('data', function(data) ***REMOVED***
        t.same(data.toString(), 'HI')
        t.end()
    ***REMOVED***)
  ***REMOVED***)
    dup.write('hello')
    dup.write('hi')
***REMOVED***)
  dup.write('hello')
})

tape('cork', function(t) ***REMOVED***
  var passthrough = through()
  var dup = duplexify(passthrough, passthrough)
  var ok = false

  dup.on('prefinish', function() ***REMOVED***
    dup.cork()
    setTimeout(function() ***REMOVED***
      ok = true
      dup.uncork()
  ***REMOVED***, 100)
***REMOVED***)
  dup.on('finish', function() ***REMOVED***
    t.ok(ok)
    t.end()
***REMOVED***)
  dup.end()
})

tape('prefinish not twice', function(t) ***REMOVED***
  var passthrough = through()
  var dup = duplexify(passthrough, passthrough)
  var prefinished = false

  dup.on('prefinish', function() ***REMOVED***
    t.ok(!prefinished, 'only prefinish once')
    prefinished = true
***REMOVED***)

  dup.on('finish', function() ***REMOVED***
    t.end()
***REMOVED***)

  dup.end()
})

tape('close', function(t) ***REMOVED***
  var passthrough = through()
  var dup = duplexify(passthrough, passthrough)

  passthrough.emit('close')
  dup.on('close', function() ***REMOVED***
    t.ok(true, 'should forward close')
    t.end()
***REMOVED***)
})

tape('works with node native streams (net)', function(t) ***REMOVED***
  t.plan(1)

  var server = net.createServer(function(socket) ***REMOVED***
    var dup = duplexify(socket, socket)

    dup.once('data', function(chunk) ***REMOVED***
      t.same(chunk, HELLO_WORLD)
      server.close()
      socket.end()
      t.end()
  ***REMOVED***)
***REMOVED***)

  server.listen(0, function () ***REMOVED***
    var socket = net.connect(server.address().port)
    var dup = duplexify(socket, socket)

    dup.write(HELLO_WORLD)
***REMOVED***)
})
