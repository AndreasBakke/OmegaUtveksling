'use strict'

var DATE_TIME = /(\d***REMOVED***1,})-(\d***REMOVED***2})-(\d***REMOVED***2}) (\d***REMOVED***2}):(\d***REMOVED***2}):(\d***REMOVED***2})(\.\d***REMOVED***1,})?.*?( BC)?$/
var DATE = /^(\d***REMOVED***1,})-(\d***REMOVED***2})-(\d***REMOVED***2})( BC)?$/
var TIME_ZONE = /([Z+-])(\d***REMOVED***2})?:?(\d***REMOVED***2})?:?(\d***REMOVED***2})?/
var INFINITY = /^-?infinity$/

module.exports = function parseDate (isoDate) ***REMOVED***
  if (INFINITY.test(isoDate)) ***REMOVED***
    // Capitalize to Infinity before passing to Number
    return Number(isoDate.replace('i', 'I'))
***REMOVED***
  var matches = DATE_TIME.exec(isoDate)

  if (!matches) ***REMOVED***
    // Force YYYY-MM-DD dates to be parsed as local time
    return getDate(isoDate) || null
***REMOVED***

  var isBC = !!matches[8]
  var year = parseInt(matches[1], 10)
  if (isBC) ***REMOVED***
    year = bcYearToNegativeYear(year)
***REMOVED***

  var month = parseInt(matches[2], 10) - 1
  var day = matches[3]
  var hour = parseInt(matches[4], 10)
  var minute = parseInt(matches[5], 10)
  var second = parseInt(matches[6], 10)

  var ms = matches[7]
  ms = ms ? 1000 * parseFloat(ms) : 0

  var date
  var offset = timeZoneOffset(isoDate)
  if (offset != null) ***REMOVED***
    date = new Date(Date.UTC(year, month, day, hour, minute, second, ms))

    // Account for years from 0 to 99 being interpreted as 1900-1999
    // by Date.UTC / the multi-argument form of the Date constructor
    if (is0To99(year)) ***REMOVED***
      date.setUTCFullYear(year)
  ***REMOVED***

    if (offset !== 0) ***REMOVED***
      date.setTime(date.getTime() - offset)
  ***REMOVED***
***REMOVED*** else ***REMOVED***
    date = new Date(year, month, day, hour, minute, second, ms)

    if (is0To99(year)) ***REMOVED***
      date.setFullYear(year)
  ***REMOVED***
***REMOVED***

  return date
}

function getDate (isoDate) ***REMOVED***
  var matches = DATE.exec(isoDate)
  if (!matches) ***REMOVED***
    return
***REMOVED***

  var year = parseInt(matches[1], 10)
  var isBC = !!matches[4]
  if (isBC) ***REMOVED***
    year = bcYearToNegativeYear(year)
***REMOVED***

  var month = parseInt(matches[2], 10) - 1
  var day = matches[3]
  // YYYY-MM-DD will be parsed as local time
  var date = new Date(year, month, day)

  if (is0To99(year)) ***REMOVED***
    date.setFullYear(year)
***REMOVED***

  return date
}

// match timezones:
// Z (UTC)
// -05
// +06:30
function timeZoneOffset (isoDate) ***REMOVED***
  if (isoDate.endsWith('+00')) ***REMOVED***
    return 0
***REMOVED***

  var zone = TIME_ZONE.exec(isoDate.split(' ')[1])
  if (!zone) return
  var type = zone[1]

  if (type === 'Z') ***REMOVED***
    return 0
***REMOVED***
  var sign = type === '-' ? -1 : 1
  var offset = parseInt(zone[2], 10) * 3600 +
    parseInt(zone[3] || 0, 10) * 60 +
    parseInt(zone[4] || 0, 10)

  return offset * sign * 1000
}

function bcYearToNegativeYear (year) ***REMOVED***
  // Account for numerical difference between representations of BC years
  // See: https://github.com/bendrucker/postgres-date/issues/5
  return -(year - 1)
}

function is0To99 (num) ***REMOVED***
  return num >= 0 && num < 100
}
