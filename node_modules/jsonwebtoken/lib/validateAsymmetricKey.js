const ASYMMETRIC_KEY_DETAILS_SUPPORTED = require('./asymmetricKeyDetailsSupported');
const RSA_PSS_KEY_DETAILS_SUPPORTED = require('./rsaPssKeyDetailsSupported');

const allowedAlgorithmsForKeys = ***REMOVED***
  'ec': ['ES256', 'ES384', 'ES512'],
  'rsa': ['RS256', 'PS256', 'RS384', 'PS384', 'RS512', 'PS512'],
  'rsa-pss': ['PS256', 'PS384', 'PS512']
};

const allowedCurves = ***REMOVED***
  ES256: 'prime256v1',
  ES384: 'secp384r1',
  ES512: 'secp521r1',
};

module.exports = function(algorithm, key) ***REMOVED***
  if (!algorithm || !key) return;

  const keyType = key.asymmetricKeyType;
  if (!keyType) return;

  const allowedAlgorithms = allowedAlgorithmsForKeys[keyType];

  if (!allowedAlgorithms) ***REMOVED***
    throw new Error(`Unknown key type "$***REMOVED***keyType}".`);
***REMOVED***

  if (!allowedAlgorithms.includes(algorithm)) ***REMOVED***
    throw new Error(`"alg" parameter for "$***REMOVED***keyType}" key type must be one of: $***REMOVED***allowedAlgorithms.join(', ')}.`)
***REMOVED***

  /*
   * Ignore the next block from test coverage because it gets executed
   * conditionally depending on the Node version. Not ignoring it would
   * prevent us from reaching the target % of coverage for versions of
   * Node under 15.7.0.
   */
  /* istanbul ignore next */
  if (ASYMMETRIC_KEY_DETAILS_SUPPORTED) ***REMOVED***
    switch (keyType) ***REMOVED***
    case 'ec':
      const keyCurve = key.asymmetricKeyDetails.namedCurve;
      const allowedCurve = allowedCurves[algorithm];

      if (keyCurve !== allowedCurve) ***REMOVED***
        throw new Error(`"alg" parameter "$***REMOVED***algorithm}" requires curve "$***REMOVED***allowedCurve}".`);
    ***REMOVED***
      break;

    case 'rsa-pss':
      if (RSA_PSS_KEY_DETAILS_SUPPORTED) ***REMOVED***
        const length = parseInt(algorithm.slice(-3), 10);
        const ***REMOVED*** hashAlgorithm, mgf1HashAlgorithm, saltLength } = key.asymmetricKeyDetails;

        if (hashAlgorithm !== `sha$***REMOVED***length}` || mgf1HashAlgorithm !== hashAlgorithm) ***REMOVED***
          throw new Error(`Invalid key for this operation, its RSA-PSS parameters do not meet the requirements of "alg" $***REMOVED***algorithm}.`);
      ***REMOVED***

        if (saltLength !== undefined && saltLength > length >> 3) ***REMOVED***
          throw new Error(`Invalid key for this operation, its RSA-PSS parameter saltLength does not meet the requirements of "alg" $***REMOVED***algorithm}.`)
      ***REMOVED***
    ***REMOVED***
      break;
  ***REMOVED***
***REMOVED***
}
