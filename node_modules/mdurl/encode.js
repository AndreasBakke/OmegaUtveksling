
'use strict';


var encodeCache = ***REMOVED***};


// Create a lookup array where anything but characters in `chars` string
// and alphanumeric chars is percent-encoded.
//
function getEncodeCache(exclude) ***REMOVED***
  var i, ch, cache = encodeCache[exclude];
  if (cache) ***REMOVED*** return cache; }

  cache = encodeCache[exclude] = [];

  for (i = 0; i < 128; i++) ***REMOVED***
    ch = String.fromCharCode(i);

    if (/^[0-9a-z]$/i.test(ch)) ***REMOVED***
      // always allow unencoded alphanumeric characters
      cache.push(ch);
  ***REMOVED*** else ***REMOVED***
      cache.push('%' + ('0' + i.toString(16).toUpperCase()).slice(-2));
  ***REMOVED***
***REMOVED***

  for (i = 0; i < exclude.length; i++) ***REMOVED***
    cache[exclude.charCodeAt(i)] = exclude[i];
***REMOVED***

  return cache;
}


// Encode unsafe characters with percent-encoding, skipping already
// encoded sequences.
//
//  - string       - string to encode
//  - exclude      - list of characters to ignore (in addition to a-zA-Z0-9)
//  - keepEscaped  - don't encode '%' in a correct escape sequence (default: true)
//
function encode(string, exclude, keepEscaped) ***REMOVED***
  var i, l, code, nextCode, cache,
      result = '';

  if (typeof exclude !== 'string') ***REMOVED***
    // encode(string, keepEscaped)
    keepEscaped  = exclude;
    exclude = encode.defaultChars;
***REMOVED***

  if (typeof keepEscaped === 'undefined') ***REMOVED***
    keepEscaped = true;
***REMOVED***

  cache = getEncodeCache(exclude);

  for (i = 0, l = string.length; i < l; i++) ***REMOVED***
    code = string.charCodeAt(i);

    if (keepEscaped && code === 0x25 /* % */ && i + 2 < l) ***REMOVED***
      if (/^[0-9a-f]***REMOVED***2}$/i.test(string.slice(i + 1, i + 3))) ***REMOVED***
        result += string.slice(i, i + 3);
        i += 2;
        continue;
    ***REMOVED***
  ***REMOVED***

    if (code < 128) ***REMOVED***
      result += cache[code];
      continue;
  ***REMOVED***

    if (code >= 0xD800 && code <= 0xDFFF) ***REMOVED***
      if (code >= 0xD800 && code <= 0xDBFF && i + 1 < l) ***REMOVED***
        nextCode = string.charCodeAt(i + 1);
        if (nextCode >= 0xDC00 && nextCode <= 0xDFFF) ***REMOVED***
          result += encodeURIComponent(string[i] + string[i + 1]);
          i++;
          continue;
      ***REMOVED***
    ***REMOVED***
      result += '%EF%BF%BD';
      continue;
  ***REMOVED***

    result += encodeURIComponent(string[i]);
***REMOVED***

  return result;
}

encode.defaultChars   = ";/?:@&=+$,-_.!~*'()#";
encode.componentChars = "-_.!~*'()";


module.exports = encode;
