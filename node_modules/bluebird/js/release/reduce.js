"use strict";
module.exports = function(Promise,
                          PromiseArray,
                          apiRejection,
                          tryConvertToPromise,
                          INTERNAL,
                          debug) ***REMOVED***
var util = require("./util");
var tryCatch = util.tryCatch;

function ReductionPromiseArray(promises, fn, initialValue, _each) ***REMOVED***
    this.constructor$(promises);
    var context = Promise._getContext();
    this._fn = util.contextBind(context, fn);
    if (initialValue !== undefined) ***REMOVED***
        initialValue = Promise.resolve(initialValue);
        initialValue._attachCancellationCallback(this);
  ***REMOVED***
    this._initialValue = initialValue;
    this._currentCancellable = null;
    if(_each === INTERNAL) ***REMOVED***
        this._eachValues = Array(this._length);
  ***REMOVED*** else if (_each === 0) ***REMOVED***
        this._eachValues = null;
  ***REMOVED*** else ***REMOVED***
        this._eachValues = undefined;
  ***REMOVED***
    this._promise._captureStackTrace();
    this._init$(undefined, -5);
}
util.inherits(ReductionPromiseArray, PromiseArray);

ReductionPromiseArray.prototype._gotAccum = function(accum) ***REMOVED***
    if (this._eachValues !== undefined &&
        this._eachValues !== null &&
        accum !== INTERNAL) ***REMOVED***
        this._eachValues.push(accum);
  ***REMOVED***
};

ReductionPromiseArray.prototype._eachComplete = function(value) ***REMOVED***
    if (this._eachValues !== null) ***REMOVED***
        this._eachValues.push(value);
  ***REMOVED***
    return this._eachValues;
};

ReductionPromiseArray.prototype._init = function() ***REMOVED***};

ReductionPromiseArray.prototype._resolveEmptyArray = function() ***REMOVED***
    this._resolve(this._eachValues !== undefined ? this._eachValues
                                                 : this._initialValue);
};

ReductionPromiseArray.prototype.shouldCopyValues = function () ***REMOVED***
    return false;
};

ReductionPromiseArray.prototype._resolve = function(value) ***REMOVED***
    this._promise._resolveCallback(value);
    this._values = null;
};

ReductionPromiseArray.prototype._resultCancelled = function(sender) ***REMOVED***
    if (sender === this._initialValue) return this._cancel();
    if (this._isResolved()) return;
    this._resultCancelled$();
    if (this._currentCancellable instanceof Promise) ***REMOVED***
        this._currentCancellable.cancel();
  ***REMOVED***
    if (this._initialValue instanceof Promise) ***REMOVED***
        this._initialValue.cancel();
  ***REMOVED***
};

ReductionPromiseArray.prototype._iterate = function (values) ***REMOVED***
    this._values = values;
    var value;
    var i;
    var length = values.length;
    if (this._initialValue !== undefined) ***REMOVED***
        value = this._initialValue;
        i = 0;
  ***REMOVED*** else ***REMOVED***
        value = Promise.resolve(values[0]);
        i = 1;
  ***REMOVED***

    this._currentCancellable = value;

    for (var j = i; j < length; ++j) ***REMOVED***
        var maybePromise = values[j];
        if (maybePromise instanceof Promise) ***REMOVED***
            maybePromise.suppressUnhandledRejections();
      ***REMOVED***
  ***REMOVED***

    if (!value.isRejected()) ***REMOVED***
        for (; i < length; ++i) ***REMOVED***
            var ctx = ***REMOVED***
                accum: null,
                value: values[i],
                index: i,
                length: length,
                array: this
          ***REMOVED***;

            value = value._then(gotAccum, undefined, undefined, ctx, undefined);

            if ((i & 127) === 0) ***REMOVED***
                value._setNoAsyncGuarantee();
          ***REMOVED***
      ***REMOVED***
  ***REMOVED***

    if (this._eachValues !== undefined) ***REMOVED***
        value = value
            ._then(this._eachComplete, undefined, undefined, this, undefined);
  ***REMOVED***
    value._then(completed, completed, undefined, value, this);
};

Promise.prototype.reduce = function (fn, initialValue) ***REMOVED***
    return reduce(this, fn, initialValue, null);
};

Promise.reduce = function (promises, fn, initialValue, _each) ***REMOVED***
    return reduce(promises, fn, initialValue, _each);
};

function completed(valueOrReason, array) ***REMOVED***
    if (this.isFulfilled()) ***REMOVED***
        array._resolve(valueOrReason);
  ***REMOVED*** else ***REMOVED***
        array._reject(valueOrReason);
  ***REMOVED***
}

function reduce(promises, fn, initialValue, _each) ***REMOVED***
    if (typeof fn !== "function") ***REMOVED***
        return apiRejection("expecting a function but got " + util.classString(fn));
  ***REMOVED***
    var array = new ReductionPromiseArray(promises, fn, initialValue, _each);
    return array.promise();
}

function gotAccum(accum) ***REMOVED***
    this.accum = accum;
    this.array._gotAccum(accum);
    var value = tryConvertToPromise(this.value, this.array._promise);
    if (value instanceof Promise) ***REMOVED***
        this.array._currentCancellable = value;
        return value._then(gotValue, undefined, undefined, this, undefined);
  ***REMOVED*** else ***REMOVED***
        return gotValue.call(this, value);
  ***REMOVED***
}

function gotValue(value) ***REMOVED***
    var array = this.array;
    var promise = array._promise;
    var fn = tryCatch(array._fn);
    promise._pushContext();
    var ret;
    if (array._eachValues !== undefined) ***REMOVED***
        ret = fn.call(promise._boundValue(), value, this.index, this.length);
  ***REMOVED*** else ***REMOVED***
        ret = fn.call(promise._boundValue(),
                              this.accum, value, this.index, this.length);
  ***REMOVED***
    if (ret instanceof Promise) ***REMOVED***
        array._currentCancellable = ret;
  ***REMOVED***
    var promiseCreated = promise._popContext();
    debug.checkForgottenReturns(
        ret,
        promiseCreated,
        array._eachValues !== undefined ? "Promise.each" : "Promise.reduce",
        promise
    );
    return ret;
}
};
