'use strict'

const expect = require('expect.js')
const EventEmitter = require('events').EventEmitter
const describe = require('mocha').describe
const it = require('mocha').it
const Pool = require('../')

describe('events', function () ***REMOVED***
  it('emits connect before callback', function (done) ***REMOVED***
    const pool = new Pool()
    let emittedClient = false
    pool.on('connect', function (client) ***REMOVED***
      emittedClient = client
  ***REMOVED***)

    pool.connect(function (err, client, release) ***REMOVED***
      if (err) return done(err)
      release()
      pool.end()
      expect(client).to.be(emittedClient)
      done()
  ***REMOVED***)
***REMOVED***)

  it('emits "connect" only with a successful connection', function () ***REMOVED***
    const pool = new Pool(***REMOVED***
      // This client will always fail to connect
      Client: mockClient(***REMOVED***
        connect: function (cb) ***REMOVED***
          process.nextTick(() => ***REMOVED***
            cb(new Error('bad news'))
        ***REMOVED***)
      ***REMOVED***,
    ***REMOVED***),
  ***REMOVED***)
    pool.on('connect', function () ***REMOVED***
      throw new Error('should never get here')
  ***REMOVED***)
    return pool.connect().catch((e) => expect(e.message).to.equal('bad news'))
***REMOVED***)

  it('emits acquire every time a client is acquired', function (done) ***REMOVED***
    const pool = new Pool()
    let acquireCount = 0
    pool.on('acquire', function (client) ***REMOVED***
      expect(client).to.be.ok()
      acquireCount++
  ***REMOVED***)
    for (let i = 0; i < 10; i++) ***REMOVED***
      pool.connect(function (err, client, release) ***REMOVED***
        if (err) return done(err)
        release()
    ***REMOVED***)
      pool.query('SELECT now()')
  ***REMOVED***
    setTimeout(function () ***REMOVED***
      expect(acquireCount).to.be(20)
      pool.end(done)
  ***REMOVED***, 100)
***REMOVED***)

  it('emits error and client if an idle client in the pool hits an error', function (done) ***REMOVED***
    const pool = new Pool()
    pool.connect(function (err, client) ***REMOVED***
      expect(err).to.equal(undefined)
      client.release()
      setImmediate(function () ***REMOVED***
        client.emit('error', new Error('problem'))
    ***REMOVED***)
      pool.once('error', function (err, errClient) ***REMOVED***
        expect(err.message).to.equal('problem')
        expect(errClient).to.equal(client)
        done()
    ***REMOVED***)
  ***REMOVED***)
***REMOVED***)
})

function mockClient(methods) ***REMOVED***
  return function () ***REMOVED***
    const client = new EventEmitter()
    Object.assign(client, methods)
    return client
***REMOVED***
}
