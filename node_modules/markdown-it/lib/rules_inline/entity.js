// Process html entity - &#123;, &#xAF;, &quot;, ...

'use strict';

var entities          = require('../common/entities');
var has               = require('../common/utils').has;
var isValidEntityCode = require('../common/utils').isValidEntityCode;
var fromCodePoint     = require('../common/utils').fromCodePoint;


var DIGITAL_RE = /^&#((?:x[a-f0-9]***REMOVED***1,6}|[0-9]***REMOVED***1,7}));/i;
var NAMED_RE   = /^&([a-z][a-z0-9]***REMOVED***1,31});/i;


module.exports = function entity(state, silent) ***REMOVED***
  var ch, code, match, pos = state.pos, max = state.posMax;

  if (state.src.charCodeAt(pos) !== 0x26/* & */) ***REMOVED*** return false; }

  if (pos + 1 < max) ***REMOVED***
    ch = state.src.charCodeAt(pos + 1);

    if (ch === 0x23 /* # */) ***REMOVED***
      match = state.src.slice(pos).match(DIGITAL_RE);
      if (match) ***REMOVED***
        if (!silent) ***REMOVED***
          code = match[1][0].toLowerCase() === 'x' ? parseInt(match[1].slice(1), 16) : parseInt(match[1], 10);
          state.pending += isValidEntityCode(code) ? fromCodePoint(code) : fromCodePoint(0xFFFD);
      ***REMOVED***
        state.pos += match[0].length;
        return true;
    ***REMOVED***
  ***REMOVED*** else ***REMOVED***
      match = state.src.slice(pos).match(NAMED_RE);
      if (match) ***REMOVED***
        if (has(entities, match[1])) ***REMOVED***
          if (!silent) ***REMOVED*** state.pending += entities[match[1]]; }
          state.pos += match[0].length;
          return true;
      ***REMOVED***
    ***REMOVED***
  ***REMOVED***
***REMOVED***

  if (!silent) ***REMOVED*** state.pending += '&'; }
  state.pos++;
  return true;
};
