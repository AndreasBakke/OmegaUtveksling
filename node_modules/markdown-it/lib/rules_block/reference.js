'use strict';


var normalizeReference   = require('../common/utils').normalizeReference;
var isSpace              = require('../common/utils').isSpace;


module.exports = function reference(state, startLine, _endLine, silent) ***REMOVED***
  var ch,
      destEndPos,
      destEndLineNo,
      endLine,
      href,
      i,
      l,
      label,
      labelEnd,
      oldParentType,
      res,
      start,
      str,
      terminate,
      terminatorRules,
      title,
      lines = 0,
      pos = state.bMarks[startLine] + state.tShift[startLine],
      max = state.eMarks[startLine],
      nextLine = startLine + 1;

  // if it's indented more than 3 spaces, it should be a code block
  if (state.sCount[startLine] - state.blkIndent >= 4) ***REMOVED*** return false; }

  if (state.src.charCodeAt(pos) !== 0x5B/* [ */) ***REMOVED*** return false; }

  // Simple check to quickly interrupt scan on [link](url) at the start of line.
  // Can be useful on practice: https://github.com/markdown-it/markdown-it/issues/54
  while (++pos < max) ***REMOVED***
    if (state.src.charCodeAt(pos) === 0x5D /* ] */ &&
        state.src.charCodeAt(pos - 1) !== 0x5C/* \ */) ***REMOVED***
      if (pos + 1 === max) ***REMOVED*** return false; }
      if (state.src.charCodeAt(pos + 1) !== 0x3A/* : */) ***REMOVED*** return false; }
      break;
  ***REMOVED***
***REMOVED***

  endLine = state.lineMax;

  // jump line-by-line until empty one or EOF
  terminatorRules = state.md.block.ruler.getRules('reference');

  oldParentType = state.parentType;
  state.parentType = 'reference';

  for (; nextLine < endLine && !state.isEmpty(nextLine); nextLine++) ***REMOVED***
    // this would be a code block normally, but after paragraph
    // it's considered a lazy continuation regardless of what's there
    if (state.sCount[nextLine] - state.blkIndent > 3) ***REMOVED*** continue; }

    // quirk for blockquotes, this line should already be checked by that rule
    if (state.sCount[nextLine] < 0) ***REMOVED*** continue; }

    // Some tags can terminate paragraph without empty line.
    terminate = false;
    for (i = 0, l = terminatorRules.length; i < l; i++) ***REMOVED***
      if (terminatorRules[i](state, nextLine, endLine, true)) ***REMOVED***
        terminate = true;
        break;
    ***REMOVED***
  ***REMOVED***
    if (terminate) ***REMOVED*** break; }
***REMOVED***

  str = state.getLines(startLine, nextLine, state.blkIndent, false).trim();
  max = str.length;

  for (pos = 1; pos < max; pos++) ***REMOVED***
    ch = str.charCodeAt(pos);
    if (ch === 0x5B /* [ */) ***REMOVED***
      return false;
  ***REMOVED*** else if (ch === 0x5D /* ] */) ***REMOVED***
      labelEnd = pos;
      break;
  ***REMOVED*** else if (ch === 0x0A /* \n */) ***REMOVED***
      lines++;
  ***REMOVED*** else if (ch === 0x5C /* \ */) ***REMOVED***
      pos++;
      if (pos < max && str.charCodeAt(pos) === 0x0A) ***REMOVED***
        lines++;
    ***REMOVED***
  ***REMOVED***
***REMOVED***

  if (labelEnd < 0 || str.charCodeAt(labelEnd + 1) !== 0x3A/* : */) ***REMOVED*** return false; }

  // [label]:   destination   'title'
  //         ^^^ skip optional whitespace here
  for (pos = labelEnd + 2; pos < max; pos++) ***REMOVED***
    ch = str.charCodeAt(pos);
    if (ch === 0x0A) ***REMOVED***
      lines++;
  ***REMOVED*** else if (isSpace(ch)) ***REMOVED***
      /*eslint no-empty:0*/
  ***REMOVED*** else ***REMOVED***
      break;
  ***REMOVED***
***REMOVED***

  // [label]:   destination   'title'
  //            ^^^^^^^^^^^ parse this
  res = state.md.helpers.parseLinkDestination(str, pos, max);
  if (!res.ok) ***REMOVED*** return false; }

  href = state.md.normalizeLink(res.str);
  if (!state.md.validateLink(href)) ***REMOVED*** return false; }

  pos = res.pos;
  lines += res.lines;

  // save cursor state, we could require to rollback later
  destEndPos = pos;
  destEndLineNo = lines;

  // [label]:   destination   'title'
  //                       ^^^ skipping those spaces
  start = pos;
  for (; pos < max; pos++) ***REMOVED***
    ch = str.charCodeAt(pos);
    if (ch === 0x0A) ***REMOVED***
      lines++;
  ***REMOVED*** else if (isSpace(ch)) ***REMOVED***
      /*eslint no-empty:0*/
  ***REMOVED*** else ***REMOVED***
      break;
  ***REMOVED***
***REMOVED***

  // [label]:   destination   'title'
  //                          ^^^^^^^ parse this
  res = state.md.helpers.parseLinkTitle(str, pos, max);
  if (pos < max && start !== pos && res.ok) ***REMOVED***
    title = res.str;
    pos = res.pos;
    lines += res.lines;
***REMOVED*** else ***REMOVED***
    title = '';
    pos = destEndPos;
    lines = destEndLineNo;
***REMOVED***

  // skip trailing spaces until the rest of the line
  while (pos < max) ***REMOVED***
    ch = str.charCodeAt(pos);
    if (!isSpace(ch)) ***REMOVED*** break; }
    pos++;
***REMOVED***

  if (pos < max && str.charCodeAt(pos) !== 0x0A) ***REMOVED***
    if (title) ***REMOVED***
      // garbage at the end of the line after title,
      // but it could still be a valid reference if we roll back
      title = '';
      pos = destEndPos;
      lines = destEndLineNo;
      while (pos < max) ***REMOVED***
        ch = str.charCodeAt(pos);
        if (!isSpace(ch)) ***REMOVED*** break; }
        pos++;
    ***REMOVED***
  ***REMOVED***
***REMOVED***

  if (pos < max && str.charCodeAt(pos) !== 0x0A) ***REMOVED***
    // garbage at the end of the line
    return false;
***REMOVED***

  label = normalizeReference(str.slice(1, labelEnd));
  if (!label) ***REMOVED***
    // CommonMark 0.20 disallows empty labels
    return false;
***REMOVED***

  // Reference can not terminate anything. This check is for safety only.
  /*istanbul ignore if*/
  if (silent) ***REMOVED*** return true; }

  if (typeof state.env.references === 'undefined') ***REMOVED***
    state.env.references = ***REMOVED***};
***REMOVED***
  if (typeof state.env.references[label] === 'undefined') ***REMOVED***
    state.env.references[label] = ***REMOVED*** title: title, href: href };
***REMOVED***

  state.parentType = oldParentType;

  state.line = startLine + lines + 1;
  return true;
};
