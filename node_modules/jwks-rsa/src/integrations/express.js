const ***REMOVED*** ArgumentError } = require('../errors');
const ***REMOVED*** JwksClient } = require('../JwksClient');
const supportedAlg = require('./config');

const handleSigningKeyError = (err, cb) => ***REMOVED***
  // If we didn't find a match, can't provide a key.
  if (err && err.name === 'SigningKeyNotFoundError') ***REMOVED***
    return cb(null);
***REMOVED***

  // If an error occured like rate limiting or HTTP issue, we'll bubble up the error.
  if (err) ***REMOVED***
    return cb(err);
***REMOVED***
};

module.exports.expressJwtSecret = function (options) ***REMOVED***
  if (options === null || options === undefined) ***REMOVED***
    throw new ArgumentError('An options object must be provided when initializing expressJwtSecret');
***REMOVED***

  const client = new JwksClient(options);
  const onError = options.handleSigningKeyError || handleSigningKeyError;

  const expressJwt7Provider = async (req, token) => ***REMOVED***
    if (!token) ***REMOVED*** return; }
    const header = token.header;
    if (!header || !supportedAlg.includes(header.alg)) ***REMOVED***
      return;
  ***REMOVED***
    try ***REMOVED***
      const key = await client.getSigningKey(header.kid);
      return key.publicKey || key.rsaPublicKey;
  ***REMOVED*** catch (err) ***REMOVED***
      return new Promise((resolve, reject) => ***REMOVED***
        onError(err, (newError) => ***REMOVED***
          if (!newError) ***REMOVED*** return resolve(); }
          reject(newError);
      ***REMOVED***);
    ***REMOVED***);
  ***REMOVED***
***REMOVED***;

  return function secretProvider(req, header, payload, cb) ***REMOVED***
    //This function has 4 parameters to make it work with express-jwt@6
    //but it also supports express-jwt@7 which only has 2.
    if (arguments.length === 4) ***REMOVED***
      expressJwt7Provider(req, ***REMOVED*** header })
        .then(key => ***REMOVED***
          setImmediate(cb, null, key);
      ***REMOVED***).catch(err => ***REMOVED***
          setImmediate(cb, err);
      ***REMOVED***);

      return;
  ***REMOVED***

    return expressJwt7Provider(req, arguments[1]);
***REMOVED***;
};
