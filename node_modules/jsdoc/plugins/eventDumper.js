/**
 * Dump information about parser events to the console.
 *
 * @module plugins/eventDumper
 */
const _ = require('underscore');
const doop = require('jsdoc/util/doop');
const dump = require('jsdoc/util/dumper').dump;
const env = require('jsdoc/env');
const util = require('util');

const conf = env.conf.eventDumper || ***REMOVED***};

// Dump the included parser events (defaults to all events)
let events = conf.include || [
    'parseBegin',
    'fileBegin',
    'beforeParse',
    'jsdocCommentFound',
    'symbolFound',
    'newDoclet',
    'fileComplete',
    'parseComplete',
    'processingComplete'
];

// Don't dump the excluded parser events
if (conf.exclude) ***REMOVED***
    events = _.difference(events, conf.exclude);
}

/**
 * Replace AST node objects in events with a placeholder.
 *
 * @param ***REMOVED***Object} o - An object whose properties may contain AST node objects.
 * @return ***REMOVED***Object} The modified object.
 */
function replaceNodeObjects(o) ***REMOVED***
    const OBJECT_PLACEHOLDER = '<Object>';

    if (o.code && o.code.node) ***REMOVED***
        // don't break the original object!
        o.code = doop(o.code);
        o.code.node = OBJECT_PLACEHOLDER;
  ***REMOVED***

    if (o.doclet && o.doclet.meta && o.doclet.meta.code && o.doclet.meta.code.node) ***REMOVED***
        // don't break the original object!
        o.doclet.meta.code = doop(o.doclet.meta.code);
        o.doclet.meta.code.node = OBJECT_PLACEHOLDER;
  ***REMOVED***

    if (o.astnode) ***REMOVED***
        o.astnode = OBJECT_PLACEHOLDER;
  ***REMOVED***

    return o;
}

/**
 * Get rid of unwanted crud in an event object.
 *
 * @param ***REMOVED***object} e The event object.
 * @return ***REMOVED***object} The fixed-up object.
 */
function cleanse(e) ***REMOVED***
    let result = ***REMOVED***};

    Object.keys(e).forEach(prop => ***REMOVED***
        // by default, don't stringify properties that contain an array of functions
        if (!conf.includeFunctions && util.isArray(e[prop]) && e[prop][0] &&
            String(typeof e[prop][0]) === 'function') ***REMOVED***
            result[prop] = `function[$***REMOVED***e[prop].length}]`;
      ***REMOVED***
        // never include functions that belong to the object
        else if (typeof e[prop] !== 'function') ***REMOVED***
            result[prop] = e[prop];
      ***REMOVED***
  ***REMOVED***);

    // allow users to omit node objects, which can be enormous
    if (conf.omitNodes) ***REMOVED***
        result = replaceNodeObjects(result);
  ***REMOVED***

    return result;
}

exports.handlers = ***REMOVED***};

events.forEach(eventType => ***REMOVED***
    exports.handlers[eventType] = e => ***REMOVED***
        console.log( dump(***REMOVED***
            type: eventType,
            content: cleanse(e)
      ***REMOVED***) );
  ***REMOVED***;
});
