var memoizer = require('./..');
var assert = require('chai').assert;

describe('lru-memoizer (queueMaxAge)', function () ***REMOVED***
  var loadTimes = 0, memoized;

  beforeEach(function () ***REMOVED***
    loadTimes = 0;
***REMOVED***);

  function observer() ***REMOVED***
    const listeners = [];
    return ***REMOVED***
      listen(listener) ***REMOVED***
        listeners.push(listener);
    ***REMOVED***,
      trigger() ***REMOVED***
        listeners.forEach(listener => listener());
    ***REMOVED***
  ***REMOVED***
***REMOVED***

  it('should create a new queue once expired', function (done) ***REMOVED***
    memoized = memoizer(***REMOVED***
      load: function (a, b, onResolve, callback) ***REMOVED***
        loadTimes++;
        onResolve(() => callback(null, a + b));
    ***REMOVED***,
      queueMaxAge: 10,
      hash: function (a, b) ***REMOVED***
        return a + '-' + b;
    ***REMOVED***
  ***REMOVED***);

    const observer1 = observer();
    const observer2 = observer();
    const observer3 = observer();
    const resolved = [];

    memoized(1, 2, observer1.listen, function (err, result) ***REMOVED***
      assert.isNull(err);
      assert.strictEqual(result, 3);
      resolved.push('A');
  ***REMOVED***);

    assert.strictEqual(loadTimes, 1);

    memoized(1, 2, assert.fail, function (err, result) ***REMOVED***
      assert.isNull(err);
      assert.strictEqual(result, 3);
      resolved.push('B');
  ***REMOVED***);

    assert.strictEqual(loadTimes, 1);

    setTimeout(() => ***REMOVED***
      // previous queue expired, this calls will be added to a new queue.
      memoized(1, 2, observer2.listen, function (err, result) ***REMOVED***
        assert.isNull(err);
        assert.strictEqual(result, 3);
        resolved.push('C');
    ***REMOVED***);

      memoized(1, 2, assert.fail, function (err, result) ***REMOVED***
        assert.isNull(err);
        assert.strictEqual(result, 3);
        resolved.push('D');
    ***REMOVED***);

      // only one new invocation to load
      assert.strictEqual(loadTimes, 2);

      setTimeout(() => ***REMOVED***
        // second queue expired, this calls will be added to a third queue.
        memoized(1, 2, observer3.listen, function (err, result) ***REMOVED***
          assert.isNull(err);
          assert.strictEqual(result, 3);
          resolved.push('E');
      ***REMOVED***);

        memoized(1, 2, assert.fail.listen, function (err, result) ***REMOVED***
          assert.isNull(err);
          assert.strictEqual(result, 3);
          resolved.push('F');
      ***REMOVED***);

        assert.strictEqual(loadTimes, 3);

        observer1.trigger();
        setImmediate(() => ***REMOVED***
          // first queue was resolved
          assert.deepEqual(['A', 'B'], resolved);

          observer3.trigger();
          setImmediate(() => ***REMOVED***
            // third queue was resolved
            assert.deepEqual(['A', 'B', 'E', 'F'], resolved);

            observer2.trigger();
            setImmediate(() => ***REMOVED***
              // second queue was resolved
              assert.deepEqual(['A', 'B', 'E', 'F', 'C', 'D'], resolved);
              done();
          ***REMOVED***);
        ***REMOVED***);
      ***REMOVED***);
    ***REMOVED***, 100);
  ***REMOVED***, 100);
***REMOVED***);
});
